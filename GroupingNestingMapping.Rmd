---
title: "GroupingNestingMapping"
output: html_notebook
---

```{r libraries}
library("tidyverse")
library("modelr")
library("broom")
```

```{r tibble df}
df <- tibble(x = c(1:6), y = rep(c("a","b"), times = 3), z = seq(10,20, by = 2))
df
```

```{r apply function to df}
df %>%
  mutate(a = mean(z))
```

```{r group}
df_group = df %>%
  group_by(y)

df_group
```


```{r apply function to df_group}
df_group %>%
  mutate(a = mean(z))
```

```{r nest df_group}
df_nest <- df_group %>%
  nest()

df_nest
```

```{r inspect nest}
df_nest$data[[1]]
```

```{r map df_nest}
df_nest <- df_nest %>%
  mutate(NestAv = map_dbl(data, ~mean(.$z)))
```

```{r map model}
df_nest <- df_nest %>%
  mutate(LinModel = map(data, ~lm(z ~ x, data = .)))

df_nest 
```
Inspect Model
```{r inspect model}
df_nest$LinModel[[1]]
```

Mdel outputs from R are in 'list' standard format, and are not consistent across model functions.

'tidy::room' can help.

```{r model output}
df_nest <- df_nest %>%
  mutate(ModelCoeff = map(LinModel, tidy))

df_nest

df_nest$ModelCoeff[[1]]
```
Extracting Individual Coefficients


What if model fails on some data subsets?
```{r model output}
df_nest <- df_nest %>%
  mutate(ModelCoeff = map(LinModel, possibly(tidy, otherwise = NULL)))

df_nest
```